<!DOCTYPE html>
<html>
	<head>
        <title>Piano MIDI Player</title>
    </head>
    <body>
        <script src="./js/soundfont-player.min.js"></script>
        <script type="module">
import * as THREE from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/build/three.module.js';
import {OrbitControls} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/controls/OrbitControls.js';
import {GLTFLoader} from 'https://threejsfundamentals.org/threejs/resources/threejs/r122/examples/jsm/loaders/GLTFLoader.js';
//import * as CapsuleBufferGeometry from './js/CapsuleBufferGeometry.js'
import * as dat from "https://cdn.skypack.dev/dat.gui@0.7.7";
import * as MidiPlayer from "./node_modules/midi-player-js/build/index.browser.js";

const scene = new THREE.Scene();
scene.background = new THREE.Color( 0xffffff );
const camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 0.1, 1000 );

const renderer = new THREE.WebGLRenderer();
renderer.shadowMap.enabled = true;
renderer.setSize( window.innerWidth, window.innerHeight );

const controls = new OrbitControls( camera, renderer.domElement );
controls.update();

//========================================================================================================
//Personas/animaciones
//========================================================================================================

var notes = []
var keyColor = undefined, bKColor = undefined

var loader = new GLTFLoader()
loader.setPath('./models/')

//Mujer
loader.load('teclas separadas.gltf', function(object){
	let xScale = 2, yScale = 2, zScale = 2
    let Piano = object.scene
    Piano.position.set(0,0,0)
    Piano.scale.set(xScale,yScale,zScale)
    Piano.rotation.set(0,Math.PI/2,0)
    scene.add(Piano)
    
	object.scene.traverse( function( child ) {
		if(child.isMesh && child.userData && child.userData.name){
			let noteName = child.userData.name
			let noteInfo = noteName.split('.')
			if(noteInfo[1]){
				notes[parseInt(noteInfo[0])] = {
					'name': noteInfo[1],
					'x': child.position.x * xScale,
					'y': child.position.y * yScale,
					'z': child.position.z * zScale,
					'ref' : child
				}
				if(bKColor==undefined && noteInfo[1].includes('#')){
					bKColor = child.material.color.getHex()
				}
				else if (keyColor==undefined && !noteInfo[1].includes('#')){
					keyColor = child.material.color.getHex()
				}
			}
		}
	})
	console.log(notes)
})


console.log(Soundfont)
var AudioContext = window.AudioContext || window.webkitAudioContext || false; 
var ac = new AudioContext || new webkitAudioContext;
var pianoPlayer = await Soundfont.instrument(ac, 'acoustic_grand_piano') 

console.log(pianoPlayer)
// Initialize player and register event handler
var player = new MidiPlayer.default.Player(function(event) {
	console.log(event);
	if(event.name==='Note on'){
		let note = notes[parseInt(event.noteNumber)]
		console.log(notes[parseInt(event.noteNumber)])
		note.ref.material.color.setHex(0xffff00)
		note.ref.position.y = note.ref.position.y-0.03;
		pianoPlayer.play(event.noteName, ac.currentTime, {gain:event.velocity/100});

		note.ref.updateMatrix()
	}
	else if(event.name==='Note off'){
		let note = notes[parseInt(event.noteNumber)]
		console.log(notes[parseInt(event.noteNumber)])
		let originalColor = (note.name.includes('#'))? bKColor:keyColor
		note.ref.material.color.setHex(originalColor)
		note.ref.position.y = note.ref.position.y+0.03;
		note.ref.updateMatrix()
	}
});

const fileReader = new FileReader()
var input = document.createElement("input")
input.type = "file"
input.onchange = ()=>{
  if(!input.files.length){
    alert('Please select a file!');
      return;
  }
  let file = input.files[0];
  let reader = new FileReader();
  let ab = reader.readAsArrayBuffer(file);
  reader.onload = (event)=>{
    //pianoPlayer.listenToMidi(file)
    //pianoPlayer.play()
    console.log(pianoPlayer)
    player.loadArrayBuffer(event.target.result)
    player.play()
  }
}
document.body.appendChild(input)
document.body.appendChild( renderer.domElement );

const clock = new THREE.Clock();

//========================================================================================================
//Playground
//========================================================================================================


//========================================================================================================
//Lights
//========================================================================================================

var light = new THREE.AmbientLight( 0xffffff, 1 );
scene.add(light)

//========================================================================================================
//Interactiveness
//========================================================================================================


//========================================================================================================
//Rendering
//========================================================================================================

camera.position.set(28.238630194247968,12.424172422949814,4.857055215081596)
camera.rotation.set(-1.7749009124891113, 1.300486193390684, 1.7823680802374888)
camera.aspect = 2.1052631578947367

const axesHelper = new THREE.AxesHelper(100)
scene.add(axesHelper)

const animate = function () {
    let delta = clock.getDelta()
    requestAnimationFrame( animate );
    renderer.render( scene, camera );
    controls.update()
};

animate();

</script>
    </body>
</html>
